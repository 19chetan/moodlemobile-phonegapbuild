webpackJsonp([65],{1790:function(n,t,e){"use strict";function i(n){return a._57(0,[(n()(),a._31(0,0,null,null,13,"ion-item",[["class","item-title item item-block"],["text-wrap",""]],null,null,null,A.b,A.a)),a._30(1,1097728,null,3,N.a,[W.a,B.a,a.t,a.V,[2,H.a]],null,null),a._52(335544320,2,{contentLabel:0}),a._52(603979776,3,{_buttons:1}),a._52(603979776,4,{_icons:1}),a._30(5,16384,null,0,G.a,[],null,null),(n()(),a._55(-1,2,["\n                "])),(n()(),a._31(7,0,null,3,5,"ion-input",[["name","title"],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],null,null,K.b,K.a)),a._30(8,671744,null,0,c.f,[[3,c.b],[8,null],[8,null],[8,null]],{name:[0,"name"]},null),a._50(2048,null,c.m,null,[c.f]),a._30(10,16384,null,0,c.n,[c.m],null,null),a._30(11,5423104,null,0,$.a,[B.a,q.a,W.a,J.a,a.t,a.V,[2,z.a],[2,N.a],[2,c.m],Q.a],{type:[0,"type"],placeholder:[1,"placeholder"]},null),a._47(131072,X.a,[Y.a,a.j]),(n()(),a._55(-1,2,["\n            "]))],function(n,t){n(t,8,0,"title");n(t,11,0,"text",a._56(t,11,1,a._44(t,12).transform("addon.mod_wiki.newpagetitle")))},function(n,t){n(t,7,0,a._44(t,10).ngClassUntouched,a._44(t,10).ngClassTouched,a._44(t,10).ngClassPristine,a._44(t,10).ngClassDirty,a._44(t,10).ngClassValid,a._44(t,10).ngClassInvalid,a._44(t,10).ngClassPending)})}function l(n){return a._57(0,[(n()(),a._31(0,0,null,null,3,"ion-badge",[["color","danger"],["item-end",""]],null,null,null,null,null)),a._30(1,16384,null,0,Z.a,[B.a,a.t,a.V],{color:[0,"color"]},null),(n()(),a._55(2,null,["",""])),a._47(131072,X.a,[Y.a,a.j])],function(n,t){n(t,1,0,"danger")},function(n,t){n(t,2,0,a._56(t,2,0,a._44(t,3).transform("addon.mod_wiki.wrongversionlock")))})}function o(n){return a._57(0,[(n()(),a._31(0,0,null,null,22,"ion-header",[],null,null,null,null,null)),a._30(1,16384,null,0,nn.a,[B.a,a.t,a.V,[2,tn.a]],null,null),(n()(),a._55(-1,null,["\n    "])),(n()(),a._31(3,0,null,null,18,"ion-navbar",[["class","toolbar"]],[[8,"hidden",0],[2,"statusbar-padding",null]],null,null,en.b,en.a)),a._30(4,49152,null,0,ln.a,[J.a,[2,tn.a],[2,on.a],B.a,a.t,a.V],null,null),(n()(),a._55(-1,3,["\n        "])),(n()(),a._31(6,0,null,3,3,"ion-title",[],null,null,null,an.b,an.a)),a._30(7,49152,null,0,rn.a,[B.a,a.t,a.V,[2,un.a],[2,ln.a]],null,null),(n()(),a._31(8,0,null,0,1,"core-format-text",[],null,null,null,null,null)),a._30(9,540672,null,0,sn.a,[a.t,g.a,_.a,p.a,Y.a,q.a,dn.a,cn.a,hn.a,gn.a,fn.a,_n.a,[2,on.a],[2,z.a]],{text:[0,"text"]},null),(n()(),a._55(-1,3,["\n\n        "])),(n()(),a._31(11,0,null,2,9,"ion-buttons",[["end",""]],null,null,null,null,null)),a._30(12,16384,null,1,pn.a,[B.a,a.t,a.V,[2,un.a],[2,ln.a]],null,null),a._52(603979776,1,{_buttons:1}),(n()(),a._55(-1,null,["\n            "])),(n()(),a._31(15,0,null,null,4,"button",[["clear",""],["ion-button",""]],[[1,"aria-label",0]],[[null,"click"]],function(n,t,e){var i=!0;if("click"===t){i=!1!==n.component.save()&&i}return i},In.b,In.a)),a._30(16,1097728,[[1,4]],0,kn.a,[[8,""],B.a,a.t,a.V],{clear:[0,"clear"]},null),a._47(131072,X.a,[Y.a,a.j]),(n()(),a._55(18,0,["\n                ","\n            "])),a._47(131072,X.a,[Y.a,a.j]),(n()(),a._55(-1,null,["\n        "])),(n()(),a._55(-1,3,["\n    "])),(n()(),a._55(-1,null,["\n"])),(n()(),a._55(-1,null,["\n"])),(n()(),a._31(24,0,null,null,32,"ion-content",[],[[2,"statusbar-padding",null],[2,"has-refresher",null]],null,null,mn.b,mn.a)),a._30(25,4374528,null,0,z.a,[B.a,q.a,Q.a,a.t,a.V,J.a,wn.a,a.M,[2,tn.a],[2,on.a]],null,null),(n()(),a._55(-1,1,["\n    "])),(n()(),a._31(27,0,null,1,28,"core-loading",[],null,null,null,vn.b,vn.a)),a._30(28,638976,null,0,bn.a,[Y.a,a.t],{hideUntil:[0,"hideUntil"]},null),(n()(),a._55(-1,0,["\n        "])),(n()(),a._31(30,0,null,0,24,"form",[["ion-list",""],["novalidate",""]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"submit"],[null,"reset"]],function(n,t,e){var i=!0;if("submit"===t){i=!1!==a._44(n,32).onSubmit(e)&&i}if("reset"===t){i=!1!==a._44(n,32).onReset()&&i}return i},null,null)),a._30(31,16384,null,0,c.w,[],null,null),a._30(32,540672,null,0,c.h,[[8,null],[8,null]],{form:[0,"form"]},null),a._50(2048,null,c.b,null,[c.h]),a._30(34,16384,null,0,c.o,[c.b],null,null),(n()(),a._55(-1,null,["\n            "])),(n()(),a._26(16777216,null,null,1,null,i)),a._30(37,16384,null,0,Pn.k,[a._11,a._6],{ngIf:[0,"ngIf"]},null),(n()(),a._55(-1,null,["\n\n            "])),(n()(),a._31(39,0,null,null,10,"ion-item",[["class","item item-block"]],null,null,null,A.b,A.a)),a._30(40,1097728,null,3,N.a,[W.a,B.a,a.t,a.V,[2,H.a]],null,null),a._52(335544320,5,{contentLabel:0}),a._52(603979776,6,{_buttons:1}),a._52(603979776,7,{_icons:1}),a._30(44,16384,null,0,G.a,[],null,null),(n()(),a._55(-1,2,["\n                "])),(n()(),a._31(46,0,null,3,2,"core-rich-text-editor",[["item-content",""],["name","wiki_page_content"]],null,null,null,yn.b,yn.a)),a._30(47,1228800,null,0,Cn.a,[_.a,On.a,cn.a,g.a,gn.a,[2,z.a],a.t],{placeholder:[0,"placeholder"],control:[1,"control"],name:[2,"name"],component:[3,"component"],componentId:[4,"componentId"]},null),a._47(131072,X.a,[Y.a,a.j]),(n()(),a._55(-1,2,["\n            "])),(n()(),a._55(-1,null,["\n\n            "])),(n()(),a._26(16777216,null,null,1,null,l)),a._30(52,16384,null,0,Pn.k,[a._11,a._6],{ngIf:[0,"ngIf"]},null),(n()(),a._55(-1,null,[" "])),(n()(),a._55(-1,null,["\n        "])),(n()(),a._55(-1,0,["\n    "])),(n()(),a._55(-1,1,["\n"])),(n()(),a._55(-1,null,["\n"]))],function(n,t){var e=t.component;n(t,9,0,e.title);n(t,16,0,"");n(t,28,0,e.loaded);n(t,32,0,e.pageForm);n(t,37,0,e.canEditTitle);n(t,47,0,a._56(t,47,0,a._44(t,48).transform("core.content")),e.contentControl,"wiki_page_content",e.component,e.componentId);n(t,52,0,e.wrongVersionLock)},function(n,t){n(t,3,0,a._44(t,4)._hidden,a._44(t,4)._sbPadding);n(t,15,0,a._56(t,15,0,a._44(t,17).transform("core.save")));n(t,18,0,a._56(t,18,0,a._44(t,19).transform("core.save")));n(t,24,0,a._44(t,25).statusbarPadding,a._44(t,25)._hasRefresher);n(t,30,0,a._44(t,34).ngClassUntouched,a._44(t,34).ngClassTouched,a._44(t,34).ngClassPristine,a._44(t,34).ngClassDirty,a._44(t,34).ngClassValid,a._44(t,34).ngClassInvalid,a._44(t,34).ngClassPending)})}Object.defineProperty(t,"__esModule",{value:!0});var a=e(0),r=e(9),u=e(7),s=e(31),d=e(30),c=e(17),h=e(21),g=e(1),f=e(85),_=e(6),p=e(10),I=e(14),k=e(41),m=e(192),w=e(237),v=e(269),b=this&&this.__decorate||function(n,t,e,i){var l,o=arguments.length,a=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,e):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(n,t,e,i);else for(var r=n.length-1;r>=0;r--)(l=n[r])&&(a=(o<3?l(a):o>3?l(t,e,a):l(t,e))||a);return o>3&&a&&Object.defineProperty(t,e,a),a},P=this&&this.__metadata||function(n,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(n,t)},y=function(){function n(n,t,e,i,l,o,a,r,u,s,d,c,h,g){this.navCtrl=e,this.sitesProvider=i,this.syncProvider=l,this.domUtils=o,this.translate=a,this.courseProvider=r,this.eventsProvider=u,this.wikiProvider=s,this.wikiOffline=d,this.wikiSync=c,this.textUtils=h,this.courseHelper=g,this.component=m.a.COMPONENT,this.forceLeave=!1,this.isDestroyed=!1,this.module=n.get("module")||{},this.courseId=n.get("courseId"),this.subwikiId=n.get("subwikiId"),this.wikiId=n.get("wikiId"),this.pageId=n.get("pageId"),this.section=n.get("section"),this.groupId=n.get("groupId"),this.userId=n.get("userId");var f=n.get("pageTitle");f=f?f.replace(/\+/g," "):"",this.initialSubwikiId=this.subwikiId,this.componentId=this.module.id,this.canEditTitle=!f,this.title=f?this.translate.instant("addon.mod_wiki.editingpage",{$a:f}):this.translate.instant("addon.mod_wiki.newpagehdr"),this.blockId=this.wikiSync.getSubwikiBlockId(this.subwikiId,this.wikiId,this.userId,this.groupId),this.contentControl=t.control(""),this.pageForm=t.group({title:f}),this.pageForm.addControl("text",this.contentControl),this.syncProvider.blockOperation(this.component,this.blockId)}return n.prototype.ngOnInit=function(){var n=this;this.fetchWikiPageData().then(function(t){if(t&&n.blockId&&!n.isDestroyed){var e=n.wikiSync.getSubwikiBlockId(n.subwikiId,n.wikiId,n.userId,n.groupId);e!=n.blockId&&(n.syncProvider.unblockOperation(n.component,n.blockId),n.blockId=e,n.syncProvider.blockOperation(n.component,n.blockId))}}).finally(function(){n.loaded=!0})},n.prototype.fetchWikiPageData=function(){var n,t=this,e=!1;if(this.pageId)this.canEditTitle=!1,this.editing=!0,this.editOffline=!1,n=this.wikiProvider.getPageContents(this.pageId).then(function(n){return t.pageForm.controls.title.setValue(n.title),t.wikiId=n.wikiid,t.subwikiId=n.subwikiid,t.title=t.translate.instant("addon.mod_wiki.editingpage",{$a:n.title}),t.groupId=n.groupid,t.userId=n.userid,e=n.caneditpage,t.wikiSync.waitForSync(t.blockId)}).then(function(){return t.domUtils.isRichTextEditorEnabled()}).then(function(n){if(t.rteEnabled=n,n)return t.wikiProvider.getSubwikiFiles(t.wikiId,t.groupId,t.userId)}).then(function(n){return t.subwikiFiles=n,t.wikiProvider.getPageForEditing(t.pageId,t.section)}).then(function(n){var i=t.rteEnabled?t.textUtils.replacePluginfileUrls(n.content,t.subwikiFiles):n.content;t.contentControl.setValue(i),t.originalContent=i,t.version=n.version,e&&(t.renewLockInterval=setInterval(function(){t.renewLock()},m.a.RENEW_LOCK_TIME))});else{var i=this.pageForm.controls.title.value;n=this.wikiSync.waitForSync(this.blockId),i?n=n.then(function(n){if(n){var e=n.created.find(function(n){return n.title==i});if(e&&e.pageId>0)return t.pageId=e.pageId,t.fetchWikiPageData()}return t.wikiOffline.getNewPage(i,t.subwikiId,t.wikiId,t.userId,t.groupId)}).then(function(n){t.contentControl.setValue(n.cachedcontent),t.originalContent=n.cachedcontent,t.editOffline=!0}).catch(function(){t.editOffline=!1}):this.editOffline=!1,n.then(function(){t.editing=!1,e=!!t.blockId})}return n.then(function(){return!0}).catch(function(n){return t.domUtils.showErrorModalDefault(n,"Error getting wiki data."),t.forceLeavePage(),!1}).finally(function(){e||(t.domUtils.showAlert(t.translate.instant("core.notice"),t.translate.instant("addon.mod_wiki.cannoteditpage")),t.forceLeavePage())})},n.prototype.forceLeavePage=function(){this.forceLeave=!0,this.navCtrl.pop()},n.prototype.goToNewOfflinePage=function(n){this.courseId&&(this.module.id||this.wikiId)?this.editOffline&&!this.previousViewPageIsDifferentOffline(n)||(this.pageParamsToLoad={module:this.module,courseId:this.courseId,pageId:null,pageTitle:n,wikiId:this.wikiId,subwikiId:this.subwikiId,userId:this.userId,groupId:this.groupId}):this.domUtils.showAlert(this.translate.instant("core.success"),this.translate.instant("core.datastoredoffline")),this.forceLeavePage()},n.prototype.gotoPage=function(n){var t=this;return this.retrieveModuleInfo(this.wikiId).then(function(){var e=!1;t.initialSubwikiId&&(!t.editing&&t.editOffline&&t.previousViewPageIsDifferentOffline(n)?e=!0:!t.editOffline&&t.previousViewIsDifferentPageOnline()&&(e=!0)),e&&(t.pageParamsToLoad={module:t.module,courseId:t.courseId,pageId:t.pageId,pageTitle:n,wikiId:t.wikiId,subwikiId:t.subwikiId,userId:t.userId,groupId:t.groupId}),t.forceLeavePage()}).catch(function(){t.forceLeavePage()})},n.prototype.hasDataChanged=function(){var n=this.pageForm.value;return!(this.originalContent==n.text||!this.editing&&!n.text&&!n.title)},n.prototype.ionViewCanLeave=function(){return!!this.forceLeave||(!this.hasDataChanged()||this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit")))},n.prototype.ionViewDidLeave=function(){this.pageParamsToLoad&&this.navCtrl.push("AddonModWikiIndexPage",this.pageParamsToLoad)},n.prototype.previousViewIsDifferentPageOnline=function(){var n=this.navCtrl.getPrevious();return!this.editing||"AddonModWikiIndexPage"!=n.component.name||n.data.module.id!=this.module.id||n.data.pageId!=this.pageId},n.prototype.previousViewPageIsDifferentOffline=function(n){var t=this.navCtrl.getPrevious();if("AddonModWikiIndexPage"!=t.component.name||t.data.module.id!=this.module.id||t.data.wikiId!=this.wikiId||t.data.pageTitle!=n)return!0;var e=parseInt(t.data.subwikiId,10)||0;if(e>0&&this.subwikiId>0)return e!=this.subwikiId;var i=parseInt(t.data.userId,10)||0,l=parseInt(t.data.groupId,10)||0;return this.userId!=i||this.groupId!=l},n.prototype.save=function(){var n,t=this,e=this.pageForm.value,i=e.title,l=this.domUtils.showModalLoading("core.sending",!0),o=e.text;if(o=this.rteEnabled?this.textUtils.restorePluginfileUrls(o,this.subwikiFiles):this.textUtils.formatHtmlLines(o),this.editing)n=this.wikiProvider.editPage(this.pageId,o,this.section).then(function(){return t.wikiProvider.invalidatePage(t.pageId).then(function(){return t.gotoPage(i)})});else{if(!i)return this.domUtils.showAlert(this.translate.instant("core.notice"),this.translate.instant("addon.mod_wiki.titleshouldnotbeempty")),void l.dismiss();n=(n=this.editOffline?Promise.resolve():this.wikiOffline.getNewPage(i,this.subwikiId,this.wikiId,this.userId,this.groupId).then(function(){return Promise.reject(t.translate.instant("addon.mod_wiki.pageexists"))},function(){})).then(function(){var n=t.wikiId||t.module&&t.module.instance;return t.wikiProvider.newPage(i,o,t.subwikiId,n,t.userId,t.groupId).then(function(e){if(e>0)return t.pageId=e,t.wikiProvider.getPageContents(t.pageId).then(function(e){var l=[];return n=parseInt(e.wikiid,10),t.subwikiId||l.push(t.wikiProvider.invalidateSubwikis(n)),t.subwikiId=parseInt(e.subwikiid,10),t.userId=parseInt(e.userid,10),t.groupId=parseInt(e.groupid,10),l.push(t.wikiProvider.invalidateSubwikiPages(n)),Promise.all(l).then(function(){return t.gotoPage(i)})}).finally(function(){t.eventsProvider.trigger(m.a.PAGE_CREATED_EVENT,{pageId:t.pageId,subwikiId:t.subwikiId,pageTitle:i,siteId:t.sitesProvider.getCurrentSiteId()})});t.goToNewOfflinePage(i)})})}return n.catch(function(n){t.domUtils.showErrorModalDefault(n,"Error saving wiki data.")}).finally(function(){l.dismiss()})},n.prototype.renewLock=function(){var n=this;this.wikiProvider.getPageForEditing(this.pageId,this.section,!0).then(function(t){t.version&&n.version!=t.version&&(n.wrongVersionLock=!0)})},n.prototype.retrieveModuleInfo=function(n){var t=this;if(this.module.id&&this.courseId)return Promise.resolve();return(this.module.id?Promise.resolve(this.module):this.courseProvider.getModuleBasicInfoByInstance(n,"wiki")).then(function(e){if(t.module=e,t.componentId=t.module.id,!t.courseId&&t.module.course)t.courseId=t.module.course;else if(!t.courseId)return t.courseHelper.getModuleCourseIdByInstance(n,"wiki").then(function(n){t.courseId=n})})},n.prototype.ngOnDestroy=function(){this.isDestroyed=!0,clearInterval(this.renewLockInterval),this.blockId&&this.syncProvider.unblockOperation(this.component,this.blockId)},n=b([Object(a.m)({selector:"page-addon-mod-wiki-edit",templateUrl:"edit.html"}),P("design:paramtypes",[r.r,c.d,r.q,g.a,f.a,_.a,u.c,I.a,h.a,m.a,w.a,v.a,p.a,k.a])],n)}(),C=this&&this.__decorate||function(n,t,e,i){var l,o=arguments.length,a=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,e):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(n,t,e,i);else for(var r=n.length-1;r>=0;r--)(l=n[r])&&(a=(o<3?l(a):o>3?l(t,e,a):l(t,e))||a);return o>3&&a&&Object.defineProperty(t,e,a),a},O=function(){function n(){}return n=C([Object(a.I)({declarations:[y],imports:[s.a,d.a,r.l.forChild(y),u.b.forChild()]})],n)}(),L=e(1243),V=e(1244),E=e(1245),x=e(1246),D=e(1247),T=e(1248),U=e(1249),j=e(1250),F=e(1251),M=e(1254),S=e(1255),R=e(1256),A=e(33),N=e(19),W=e(18),B=e(3),H=e(29),G=e(32),K=e(94),$=e(76),q=e(13),J=e(27),z=e(24),Q=e(25),X=e(28),Y=e(15),Z=e(229),nn=e(402),tn=e(34),en=e(1252),ln=e(182),on=e(20),an=e(1253),rn=e(315),un=e(227),sn=e(39),dn=e(4),cn=e(23),hn=e(2),gn=e(16),fn=e(12),_n=e(22),pn=e(403),In=e(43),kn=e(37),mn=e(183),wn=e(93),vn=e(57),bn=e(55),Pn=e(8),yn=e(260),Cn=e(210),On=e(157),Ln=e(54),Vn=a._29({encapsulation:2,styles:[],data:{}}),En=a._27("page-addon-mod-wiki-edit",y,function(n){return a._57(0,[(n()(),a._31(0,0,null,null,1,"page-addon-mod-wiki-edit",[],null,null,null,o,Vn)),a._30(1,245760,null,0,y,[Ln.a,c.d,on.a,g.a,f.a,_.a,Y.a,I.a,h.a,m.a,w.a,v.a,p.a,k.a],null,null)],function(n,t){n(t,1,0)},null)},{},{},[]),xn=e(311),Dn=e(312),Tn=e(314),Un=e(313),jn=e(401),Fn=e(615),Mn=e(111),Sn=e(228);e.d(t,"AddonModWikiEditPageModuleNgFactory",function(){return Rn});var Rn=a._28(O,[],function(n){return a._40([a._41(512,a.o,a._21,[[8,[L.a,V.a,E.a,x.a,D.a,T.a,U.a,j.a,F.a,M.a,S.a,R.a,En]],[3,a.o],a.K]),a._41(4608,Pn.m,Pn.l,[a.G,[2,Pn.v]]),a._41(4608,c.x,c.x,[]),a._41(4608,c.d,c.d,[]),a._41(4608,xn.b,xn.a,[]),a._41(4608,Dn.a,Dn.b,[]),a._41(4608,Tn.b,Tn.a,[]),a._41(4608,Un.b,Un.a,[]),a._41(4608,Y.a,Y.a,[jn.a,xn.b,Dn.a,Tn.b,Un.b,Y.b,Y.c]),a._41(512,Pn.b,Pn.b,[]),a._41(512,c.v,c.v,[]),a._41(512,c.i,c.i,[]),a._41(512,c.s,c.s,[]),a._41(512,Fn.a,Fn.a,[]),a._41(512,u.b,u.b,[]),a._41(512,d.a,d.a,[]),a._41(512,Mn.a,Mn.a,[]),a._41(512,s.a,s.a,[]),a._41(512,Fn.b,Fn.b,[]),a._41(512,O,O,[]),a._41(256,Y.c,void 0,[]),a._41(256,Y.b,void 0,[]),a._41(256,Sn.a,y,[])])})}});